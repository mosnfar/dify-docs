# اجرای کد

## فهرست محتوا

* [مقدمه](code.md#introduction)
* [سناریوهای استفاده](code.md#usage-scenarios)
* [استقرار محلی](code.md#local-deployment)
* [سیاست‌های امنیتی](code.md#security-policies)

## مقدمه

گره کد از اجرای کد پایتون/NodeJS برای انجام تبدیلات داده در یک گردش کار پشتیبانی می‌کند. می‌تواند گردش کار شما را ساده‌تر کند و برای سناریوهایی مانند عملیات ریاضی، تبدیلات JSON، پردازش متن و موارد دیگر مناسب است.

این گره انعطاف‌پذیری را برای توسعه‌دهندگان به طور قابل توجهی افزایش می‌دهد و به آنها امکان می‌دهد تا اسکریپت‌های سفارشی پایتون یا جاوا اسکریپت را در گردش کار تعبیه کنند و متغیرها را به روش‌هایی که گره‌های از پیش تنظیم شده نمی‌توانند به دست آورند، دستکاری کنند. از طریق گزینه‌های پیکربندی، می‌توانید متغیرهای ورودی و خروجی مورد نیاز را مشخص کنید و کد اجرایی متناظر را بنویسید:

<figure><img src="../../../.gitbook/assets/image (157).png" alt="" width="375"><figcaption></figcaption></figure>

## پیکربندی

اگر نیاز به استفاده از متغیرهای گره‌های دیگر در گره کد دارید، باید نام متغیرها را در "متغیرهای ورودی" تعریف کنید و به این متغیرها ارجاع دهید. می‌توانید به [رجوع به متغیرها](../key-concept.md#variables) مراجعه کنید.

## سناریوهای استفاده

با استفاده از گره کد، می‌توانید عملیات متداول زیر را انجام دهید:

### پردازش داده‌های ساخت‌یافته

در گردش کارها، اغلب مجبور به مقابله با پردازش داده‌های بدون ساختار مانند تجزیه، استخراج و تبدیل رشته‌های JSON هستید. یک مثال معمولی پردازش داده‌ها از یک گره HTTP است. در ساختارهای برگشتی API مشترک، ممکن است داده‌ها در چندین لایه از اشیاء JSON تو در تو قرار داشته باشند و شما نیاز دارید که زمینه‌های خاصی را استخراج کنید. گره کد می‌تواند به شما در انجام این عملیات کمک کند. در اینجا یک مثال ساده وجود دارد که زمینه `data.name` را از یک رشته JSON که توسط یک گره HTTP برگردانده شده است، استخراج می‌کند:

```python
def main(http_response: str) -> str:
    import json
    data = json.loads(http_response)
    return {
        # توجه به اعلام 'result' در متغیرهای خروجی
        'result': data['data']['name'] 
    }
```

### محاسبات ریاضی

هنگامی که نیاز به انجام محاسبات ریاضی پیچیده در یک گردش کار دارید، می‌توانید از گره کد نیز استفاده کنید. به عنوان مثال، محاسبه یک فرمول ریاضی پیچیده یا انجام برخی تجزیه و تحلیل‌های آماری روی داده‌ها. در اینجا یک مثال ساده وجود دارد که واریانس یک آرایه را محاسبه می‌کند:

```python
def main(x: list) -> float:
    return {
        # توجه به اعلام 'result' در متغیرهای خروجی
        'result': sum([(i - sum(x) / len(x)) ** 2 for i in x]) / len(x)
    }
```

### الحاق داده‌ها

گاهی اوقات ممکن است نیاز به الحاق چندین منبع داده مانند چندین بازیابی دانش، جستجوی داده‌ها، تماس API و غیره داشته باشید. گره کد می‌تواند به شما در ادغام این منابع داده با هم کمک کند. در اینجا یک مثال ساده وجود دارد که داده‌ها را از دو پایگاه دانش ادغام می‌کند:

```python
def main(knowledge1: list, knowledge2: list) -> list:
    return {
        # توجه به اعلام 'result' در متغیرهای خروجی
        'result': knowledge1 + knowledge2
    }
```

## استقرار محلی

اگر شما یک کاربر استقرار محلی هستید، باید یک سرویس شنود را برای اطمینان از اینکه کد مخرب اجرا نمی‌شود، راه‌اندازی کنید. این سرویس به استفاده از Docker نیاز دارد. می‌توانید اطلاعات خاص در مورد سرویس شنود را [در اینجا](https://github.com/langgenius/dify/tree/main/docker/docker-compose.middleware.yaml) بیابید. همچنین می‌توانید سرویس را به طور مستقیم از طریق `docker-compose` راه‌اندازی کنید:

```bash
docker-compose -f docker-compose.middleware.yaml up -d
```

## سیاست‌های امنیتی

هر دو محیط اجرای پایتون و جاوا اسکریپت به شدت ایزوله شده‌اند (شنود شده‌اند) تا امنیت را تضمین کنند. این بدان معناست که توسعه‌دهندگان نمی‌توانند از توابعی که منابع سیستم را به مقدار زیادی مصرف می‌کنند یا ممکن است خطرات امنیتی ایجاد کنند، مانند دسترسی مستقیم به سیستم فایل، ایجاد درخواست‌های شبکه یا اجرای دستورات سطح سیستم عامل استفاده کنند. این محدودیت‌ها اجرای ایمن کد را تضمین می‌کنند و از مصرف بیش از حد منابع سیستم جلوگیری می‌کنند.

### سؤالات متداول

**چرا نمی‌توانم کد را در گره کد ذخیره کنم؟**

لطفاً بررسی کنید که آیا کد شامل رفتارهای بالقوه خطرناک است یا خیر. به عنوان مثال:

```python
def main() -> dict:
    return {
        "result": open("/etc/passwd").read(),
    }
```

این قطعه کد مشکلات زیر را دارد:

* **دسترسی غیرمجاز به فایل:** کد سعی در خواندن فایل "/etc/passwd" دارد که یک فایل سیستم بحرانی در سیستم‌های Unix/Linux است که اطلاعات حساب کاربری را ذخیره می‌کند.
* **افشاگری اطلاعات حساس:** فایل "/etc/passwd" اطلاعات مهمی در مورد کاربران سیستم مانند نام کاربری، شناسه کاربری، شناسه گروه، مسیرهای دایرکتوری خانگی و غیره را شامل می‌شود. دسترسی مستقیم می‌تواند منجر به نشت اطلاعات شود.

کد خطرناک به طور خودکار توسط Cloudflare WAF مسدود خواهد شد. می‌توانید با بررسی برگه "شبکه" در "ابزارهای توسعه وب" مرورگر خود، بررسی کنید که آیا مسدود شده است یا خیر.

<figure><img src="broken-reference" alt=""><figcaption><p>Cloudflare WAF</p></figcaption></figure>



